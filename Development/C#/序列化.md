序列化
using System;

using System.IO;

using System.IO.IsolatedStorage;

using System.Runtime.Serialization.Formatters.Binary;

using System.Xml.Serialization;

namespace DelftTools.Utils.Xml.Serialization

{

    /// &lt;summary&gt;

    /// Serialization format types.&lt;para /&gt;

    /// For serialization of an object to an XML Document file.&lt;para /&gt;

    /// For serialization of an object to an XML Binary file.&lt;para /&gt;

    /// For reading/writing data to an XML file.&lt;para /&gt;

    /// For accessing user isolated data.

    /// &lt;/summary&gt;

    public enum SerializedFormat

    {

        /// &lt;summary&gt;

        /// Binary serialization format.

        /// &lt;/summary&gt;

        Binary,

        /// &lt;summary&gt;

        /// Document serialization format.

        /// &lt;/summary&gt;

        Document

    }

    /// &lt;summary&gt;

    /// Facade to XML serialization and deserialization of strongly typed objects to/from an XML file.

    /// &lt;seealso href="http://samples.gotdotnet.com/"&gt;References: XML Serialization.&lt;/seealso&gt;&lt;para /&gt;

    /// &lt;seealso cref="http://samples.gotdotnet.com/QuickStart/howto/default.aspx?url=/quickstart/howto/doc/xmlserialization/rwobjfromxml.aspx"/&gt;

   /// &lt;/summary&gt;

    public static class ObjectXmlSerializer&lt;T&gt; where T : class // Specify that T must be a class.

    {

        \#region Load methods

        /// &lt;summary&gt;

        /// Loads an object from an XML file in Document format.

        /// &lt;/summary&gt;

        /// &lt;example&gt;

        /// &lt;code&gt;

        /// serializableObject = ObjectXmlSerializer&lt;SerializableObject&gt;.Load(@"C:\\XMLObjects.xml");

        /// &lt;/code&gt;

        /// &lt;/example&gt;

        /// &lt;param name="path"&gt;Path of the file to load the object from.&lt;/param&gt;

        /// &lt;returns&gt;Object loaded from an XML file in Document format.&lt;/returns&gt;

        public static T Load(string path)

        {

            T serializableObject = LoadFromDocumentFormat(null, path, null);

            return serializableObject;

        }

        /// &lt;summary&gt;

        /// Loads an object from an XML file using a specified serialized format.

        /// &lt;/summary&gt;

        /// &lt;example&gt;

        /// &lt;code&gt;

        /// serializableObject = ObjectXmlSerializer&lt;SerializableObject&gt;.Load(@"C:\\XMLObjects.xml", SerializedFormat.Binary);

        /// &lt;/code&gt;

        /// &lt;/example&gt;       

        /// &lt;param name="path"&gt;Path of the file to load the object from.&lt;/param&gt;

        /// &lt;param name="serializedFormat"&gt;XML serialized format used to load the object.&lt;/param&gt;

        /// &lt;returns&gt;Object loaded from an XML file using the specified serialized format.&lt;/returns&gt;

        public static T Load(string path, SerializedFormat serializedFormat)

        {

            T serializableObject;

            switch (serializedFormat)

            {

                case SerializedFormat.Binary:

                    serializableObject = LoadFromBinaryFormat(path, null);

                    break;

                case SerializedFormat.Document:

                default:

                    serializableObject = LoadFromDocumentFormat(null, path, null);

                    break;

            }

            return serializableObject;

        }

        /// &lt;summary&gt;

        /// Loads an object from an XML file in Document format, supplying extra data types to enable deserialization of custom types within the object.

        /// &lt;/summary&gt;

        /// &lt;example&gt;

        /// &lt;code&gt;

        /// serializableObject = ObjectXmlSerializer&lt;SerializableObject&gt;.Load(@"C:\\XMLObjects.xml", new Type\[\] { typeof(MyCustomType) });

        /// &lt;/code&gt;

        /// &lt;/example&gt;

        /// &lt;param name="path"&gt;Path of the file to load the object from.&lt;/param&gt;

        /// &lt;param name="extraTypes"&gt;Extra data types to enable deserialization of custom types within the object.&lt;/param&gt;

        /// &lt;returns&gt;Object loaded from an XML file in Document format.&lt;/returns&gt;

        public static T Load(string path, Type\[\] extraTypes)

        {

            T serializableObject = LoadFromDocumentFormat(extraTypes, path, null);

            return serializableObject;

        }

        /// &lt;summary&gt;

        /// Loads an object from an XML file in Document format, located in a specified isolated storage area.

        /// &lt;/summary&gt;

        /// &lt;example&gt;

        /// &lt;code&gt;

        /// serializableObject = ObjectXmlSerializer&lt;SerializableObject&gt;.Load("XMLObjects.xml", IsolatedStorageFile.GetUserStoreForAssembly());

        /// &lt;/code&gt;

        /// &lt;/example&gt;

        /// &lt;param name="fileName"&gt;Name of the file in the isolated storage area to load the object from.&lt;/param&gt;

        /// &lt;param name="isolatedStorageDirectory"&gt;Isolated storage area directory containing the XML file to load the object from.&lt;/param&gt;

        /// &lt;returns&gt;Object loaded from an XML file in Document format located in a specified isolated storage area.&lt;/returns&gt;

        public static T Load(string fileName, IsolatedStorageFile isolatedStorageDirectory)

        {

            T serializableObject = LoadFromDocumentFormat(null, fileName, isolatedStorageDirectory);

            return serializableObject;

        }

        /// &lt;summary&gt;

        /// Loads an object from an XML file located in a specified isolated storage area, using a specified serialized format.

        /// &lt;/summary&gt;

        /// &lt;example&gt;

        /// &lt;code&gt;

        /// serializableObject = ObjectXmlSerializer&lt;SerializableObject&gt;.Load("XMLObjects.xml", IsolatedStorageFile.GetUserStoreForAssembly(), SerializedFormat.Binary);

        /// &lt;/code&gt;

        /// &lt;/example&gt;       

        /// &lt;param name="fileName"&gt;Name of the file in the isolated storage area to load the object from.&lt;/param&gt;

        /// &lt;param name="isolatedStorageDirectory"&gt;Isolated storage area directory containing the XML file to load the object from.&lt;/param&gt;

        /// &lt;param name="serializedFormat"&gt;XML serialized format used to load the object.&lt;/param&gt;       

        /// &lt;returns&gt;Object loaded from an XML file located in a specified isolated storage area, using a specified serialized format.&lt;/returns&gt;

        public static T Load(string fileName, IsolatedStorageFile isolatedStorageDirectory,

                             SerializedFormat serializedFormat)

        {

            T serializableObject;

            switch (serializedFormat)

            {

                case SerializedFormat.Binary:

                    serializableObject = LoadFromBinaryFormat(fileName, isolatedStorageDirectory);

                    break;

                case SerializedFormat.Document:

                default:

                    serializableObject = LoadFromDocumentFormat(null, fileName, isolatedStorageDirectory);

                    break;

            }

            return serializableObject;

        }

        /// &lt;summary&gt;

        /// Loads an object from an XML file in Document format, located in a specified isolated storage area, and supplying extra data types to enable deserialization of custom types within the object.

        /// &lt;/summary&gt;

        /// &lt;example&gt;

        /// &lt;code&gt;

        /// serializableObject = ObjectXmlSerializer&lt;SerializableObject&gt;.Load("XMLObjects.xml", IsolatedStorageFile.GetUserStoreForAssembly(), new Type\[\] { typeof(MyCustomType) });

        /// &lt;/code&gt;

        /// &lt;/example&gt;       

        /// &lt;param name="fileName"&gt;Name of the file in the isolated storage area to load the object from.&lt;/param&gt;

        /// &lt;param name="isolatedStorageDirectory"&gt;Isolated storage area directory containing the XML file to load the object from.&lt;/param&gt;

        /// &lt;param name="extraTypes"&gt;Extra data types to enable deserialization of custom types within the object.&lt;/param&gt;

        /// &lt;returns&gt;Object loaded from an XML file located in a specified isolated storage area, using a specified serialized format.&lt;/returns&gt;

        public static T Load(string fileName, IsolatedStorageFile isolatedStorageDirectory, Type\[\] extraTypes)

        {

            T serializableObject = LoadFromDocumentFormat(null, fileName, isolatedStorageDirectory);

            return serializableObject;

        }

        \#endregion

        \#region Save methods

        /// &lt;summary&gt;

        /// Saves an object to an XML file in Document format.

        /// &lt;/summary&gt;

        /// &lt;example&gt;

        /// &lt;code&gt;       

        /// SerializableObject serializableObject = new SerializableObject();

        ///

        /// ObjectXmlSerializer&lt;SerializableObject&gt;.Save(serializableObject, @"C:\\XMLObjects.xml");

        /// &lt;/code&gt;

        /// &lt;/example&gt;

        /// &lt;param name="serializableObject"&gt;Serializable object to be saved to file.&lt;/param&gt;

        /// &lt;param name="path"&gt;Path of the file to save the object to.&lt;/param&gt;

        public static void Save(T serializableObject, string path)

        {

            SaveToDocumentFormat(serializableObject, null, path, null);

        }

        /// &lt;summary&gt;

        /// Saves an object to an XML file using a specified serialized format.

        /// &lt;/summary&gt;

        /// &lt;example&gt;

        /// &lt;code&gt;

        /// SerializableObject serializableObject = new SerializableObject();

        ///

        /// ObjectXmlSerializer&lt;SerializableObject&gt;.Save(serializableObject, @"C:\\XMLObjects.xml", SerializedFormat.Binary);

        /// &lt;/code&gt;

        /// &lt;/example&gt;

        /// &lt;param name="serializableObject"&gt;Serializable object to be saved to file.&lt;/param&gt;

        /// &lt;param name="path"&gt;Path of the file to save the object to.&lt;/param&gt;

        /// &lt;param name="serializedFormat"&gt;XML serialized format used to save the object.&lt;/param&gt;

        public static void Save(T serializableObject, string path, SerializedFormat serializedFormat)

        {

            switch (serializedFormat)

            {

                case SerializedFormat.Binary:

                    SaveToBinaryFormat(serializableObject, path, null);

                    break;

                case SerializedFormat.Document:

                default:

                    SaveToDocumentFormat(serializableObject, null, path, null);

                    break;

            }

        }

        /// &lt;summary&gt;

        /// Saves an object to an XML file in Document format, supplying extra data types to enable serialization of custom types within the object.

        /// &lt;/summary&gt;

        /// &lt;example&gt;

        /// &lt;code&gt;       

        /// SerializableObject serializableObject = new SerializableObject();

        ///

        /// ObjectXmlSerializer&lt;SerializableObject&gt;.Save(serializableObject, @"C:\\XMLObjects.xml", new Type\[\] { typeof(MyCustomType) });

        /// &lt;/code&gt;

        /// &lt;/example&gt;

        /// &lt;param name="serializableObject"&gt;Serializable object to be saved to file.&lt;/param&gt;

        /// &lt;param name="path"&gt;Path of the file to save the object to.&lt;/param&gt;

        /// &lt;param name="extraTypes"&gt;Extra data types to enable serialization of custom types within the object.&lt;/param&gt;

        public static void Save(T serializableObject, string path, Type\[\] extraTypes)

        {

            SaveToDocumentFormat(serializableObject, extraTypes, path, null);

        }

        /// &lt;summary&gt;

        /// Saves an object to an XML file in Document format, located in a specified isolated storage area.

        /// &lt;/summary&gt;

        /// &lt;example&gt;

        /// &lt;code&gt;       

        /// SerializableObject serializableObject = new SerializableObject();

        ///

        /// ObjectXmlSerializer&lt;SerializableObject&gt;.Save(serializableObject, "XMLObjects.xml", IsolatedStorageFile.GetUserStoreForAssembly());

        /// &lt;/code&gt;

        /// &lt;/example&gt;

        /// &lt;param name="serializableObject"&gt;Serializable object to be saved to file.&lt;/param&gt;

        /// &lt;param name="fileName"&gt;Name of the file in the isolated storage area to save the object to.&lt;/param&gt;

        /// &lt;param name="isolatedStorageDirectory"&gt;Isolated storage area directory containing the XML file to save the object to.&lt;/param&gt;

        public static void Save(T serializableObject, string fileName, IsolatedStorageFile isolatedStorageDirectory)

        {

            SaveToDocumentFormat(serializableObject, null, fileName, isolatedStorageDirectory);

        }

        /// &lt;summary&gt;

        /// Saves an object to an XML file located in a specified isolated storage area, using a specified serialized format.

        /// &lt;/summary&gt;

        /// &lt;example&gt;

        /// &lt;code&gt;       

        /// SerializableObject serializableObject = new SerializableObject();

        ///

        /// ObjectXmlSerializer&lt;SerializableObject&gt;.Save(serializableObject, "XMLObjects.xml", IsolatedStorageFile.GetUserStoreForAssembly(), SerializedFormat.Binary);

        /// &lt;/code&gt;

        /// &lt;/example&gt;

        /// &lt;param name="serializableObject"&gt;Serializable object to be saved to file.&lt;/param&gt;

        /// &lt;param name="fileName"&gt;Name of the file in the isolated storage area to save the object to.&lt;/param&gt;

        /// &lt;param name="isolatedStorageDirectory"&gt;Isolated storage area directory containing the XML file to save the object to.&lt;/param&gt;

        /// &lt;param name="serializedFormat"&gt;XML serialized format used to save the object.&lt;/param&gt;       

        public static void Save(T serializableObject, string fileName, IsolatedStorageFile isolatedStorageDirectory,

                                SerializedFormat serializedFormat)

        {

            switch (serializedFormat)

            {

                case SerializedFormat.Binary:

                    SaveToBinaryFormat(serializableObject, fileName, isolatedStorageDirectory);

                    break;

                case SerializedFormat.Document:

                default:

                    SaveToDocumentFormat(serializableObject, null, fileName, isolatedStorageDirectory);

                    break;

            }

        }

        /// &lt;summary&gt;

        /// Saves an object to an XML file in Document format, located in a specified isolated storage area, and supplying extra data types to enable serialization of custom types within the object.

        /// &lt;/summary&gt;

        /// &lt;example&gt;

        /// &lt;code&gt;

        /// SerializableObject serializableObject = new SerializableObject();

        ///

        /// ObjectXmlSerializer&lt;SerializableObject&gt;.Save(serializableObject, "XMLObjects.xml", IsolatedStorageFile.GetUserStoreForAssembly(), new Type\[\] { typeof(MyCustomType) });

        /// &lt;/code&gt;

        /// &lt;/example&gt;       

        /// &lt;param name="serializableObject"&gt;Serializable object to be saved to file.&lt;/param&gt;

        /// &lt;param name="fileName"&gt;Name of the file in the isolated storage area to save the object to.&lt;/param&gt;

        /// &lt;param name="isolatedStorageDirectory"&gt;Isolated storage area directory containing the XML file to save the object to.&lt;/param&gt;

        /// &lt;param name="extraTypes"&gt;Extra data types to enable serialization of custom types within the object.&lt;/param&gt;

        public static void Save(T serializableObject, string fileName, IsolatedStorageFile isolatedStorageDirectory,

                                Type\[\] extraTypes)

        {

            SaveToDocumentFormat(serializableObject, null, fileName, isolatedStorageDirectory);

        }

        \#endregion

        \#region Private

        private static FileStream CreateFileStream(IsolatedStorageFile isolatedStorageFolder, string path)

        {

            FileStream fileStream;

            if (isolatedStorageFolder == null)

                fileStream = new FileStream(path, FileMode.OpenOrCreate);

            else

                fileStream = new IsolatedStorageFileStream(path, FileMode.OpenOrCreate, isolatedStorageFolder);

            return fileStream;

        }

        private static T LoadFromBinaryFormat(string path, IsolatedStorageFile isolatedStorageFolder)

        {

            T serializableObject;

            using (FileStream fileStream = CreateFileStream(isolatedStorageFolder, path))

            {

                BinaryFormatter binaryFormatter = new BinaryFormatter();

                serializableObject = binaryFormatter.Deserialize(fileStream) as T;

            }

            return serializableObject;

        }

        private static T LoadFromDocumentFormat(Type\[\] extraTypes, string path,

                                                IsolatedStorageFile isolatedStorageFolder)

        {

            T serializableObject;

            using (TextReader textReader = CreateTextReader(isolatedStorageFolder, path))

            {

                XmlSerializer xmlSerializer = CreateXmlSerializer(extraTypes);

                serializableObject = xmlSerializer.Deserialize(textReader) as T;

            }

            return serializableObject;

        }

        private static TextReader CreateTextReader(IsolatedStorageFile isolatedStorageFolder, string path)

        {

            TextReader textReader;

            if (isolatedStorageFolder == null)

                textReader = new StreamReader(path);

            else

                textReader = new StreamReader(new IsolatedStorageFileStream(path, FileMode.Open, isolatedStorageFolder));

            return textReader;

        }

        private static TextWriter CreateTextWriter(IsolatedStorageFile isolatedStorageFolder, string path)

        {

            TextWriter textWriter;

            if (isolatedStorageFolder == null)

            {

                textWriter = new StreamWriter(path);

            }

            else

            {

                textWriter =

                    new StreamWriter(new IsolatedStorageFileStream(path, FileMode.OpenOrCreate, isolatedStorageFolder));

            }

            return textWriter;

        }

        private static XmlSerializer CreateXmlSerializer(Type\[\] extraTypes)

        {

            Type ObjectType = typeof (T);

            XmlSerializer xmlSerializer;

            if (extraTypes != null)

                xmlSerializer = new XmlSerializer(ObjectType, extraTypes);

            else

                xmlSerializer = new XmlSerializer(ObjectType);

            return xmlSerializer;

        }

        private static void SaveToDocumentFormat(T serializableObject, Type\[\] extraTypes, string path,

                                                 IsolatedStorageFile isolatedStorageFolder)

        {

            using (TextWriter textWriter = CreateTextWriter(isolatedStorageFolder, path))

            {

                XmlSerializer xmlSerializer = CreateXmlSerializer(extraTypes);

                XmlSerializerNamespaces ns = new XmlSerializerNamespaces();

                ns.Add("", "");

                xmlSerializer.Serialize(textWriter, serializableObject, ns);

            }

        }

        private static void SaveToBinaryFormat(T serializableObject, string path,

                                               IsolatedStorageFile isolatedStorageFolder)

        {

            using (FileStream fileStream = CreateFileStream(isolatedStorageFolder, path))

            {

                BinaryFormatter binaryFormatter = new BinaryFormatter();

                binaryFormatter.Serialize(fileStream, serializableObject);

            }

        }

        \#endregion

    }

}


